(()=>{"use strict";var e={312:function(e,t,i){var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(i(862)),a=document.getElementById("gfx"),{width:s,height:o}=a.getBoundingClientRect(),u=window.devicePixelRatio;a.width=s*u,a.height=o*u;const d=new ResizeObserver((e=>{for(const t of e)if(t.target===a){const e=window.devicePixelRatio,{width:i,height:n}=t.contentRect;a.width=i*e,a.height=n*e}}));d.observe(a,{box:"device-pixel-content-box"}),new r.default(a).start()},862:function(e,t,i){var n=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(r,a){function s(e){try{u(n.next(e))}catch(e){a(e)}}function o(e){try{u(n.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,o)}u((n=n.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const a=r(i(861)),s=r(i(535)),o=r(i(600)),u={vertices:new Float32Array([1,-1,0,-1,-1,0,-1,1,0,1,1,0]),uvs:new Float32Array([1,1,0,1,0,0,1,0]),indices:new Uint16Array([0,1,2,2,3,0])},d=(e,t,i)=>{let n={size:t.byteLength+3&-4,usage:i,mappedAtCreation:!0},r=e.createBuffer(n);return(t instanceof Uint16Array?new Uint16Array(r.getMappedRange()):new Float32Array(r.getMappedRange())).set(t),r.unmap(),r},c=512,l=Math.ceil(2);t.default=class{constructor(e){this.previousFrameTimestamp=0,this.pingpong=0,this.render=(e=0)=>{const t=Math.min(17,e-this.previousFrameTimestamp)/1e3;this.previousFrameTimestamp=e,this.simParamValues.set([Math.random(),t]),this.device.queue.writeBuffer(this.simParamBuffer,0,this.simParamValues);const i=this.device.createCommandEncoder();this.encodeDecayCommands(i),this.encodeAgentComputeCommands(i),this.encodeBlitCommands(i),this.device.queue.submit([i.finish()]),this.pingpong=this.pingpong?0:1,requestAnimationFrame(this.render)},this.canvas=e}start(){return n(this,void 0,void 0,(function*(){(yield this.initializeAPI())&&(this.resizeBackings(),this.initializeSimParams(),this.initializeBlitResources(),this.initializeAgentResources(),this.render())}))}initializeAPI(){return n(this,void 0,void 0,(function*(){try{const e=navigator.gpu;if(!e)return!1;this.adapter=yield e.requestAdapter(),this.device=yield this.adapter.requestDevice({requiredFeatures:["float32-filterable"]}),this.queue=this.device.queue}catch(e){return console.error(e),!1}return!0}))}initializeSimParams(){this.simParamValues=new Float32Array([Math.random(),.0166]),this.simParamBuffer=d(this.device,this.simParamValues,GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST),this.simParamsUniformLayout=this.device.createBindGroupLayout({label:"AgentSimParams",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE|GPUShaderStage.FRAGMENT,buffer:{type:"uniform",minBindingSize:8}}]}),this.simParamBindGroup=this.device.createBindGroup({label:"SimParamUniforms",layout:this.simParamsUniformLayout,entries:[{binding:0,resource:{buffer:this.simParamBuffer}}]})}initializeAgentResources(){const e=new Float32Array(512);for(let t=0;t<512;t+=4){const i=2*Math.random()*Math.PI;e[t+0]=Math.random()*c,e[t+1]=Math.random()*c,e[t+2]=Math.sin(i)*c/10,e[t+3]=Math.cos(i)*c/10}this.agentBuffers=[{buffer:d(this.device,e,GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE)},{buffer:d(this.device,e,GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE)}];const t=this.device.createShaderModule({code:s.default}),i=this.device.createShaderModule({code:o.default}),n=this.device.createBindGroupLayout({label:"AgentFieldBindGroup",entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),r=this.device.createPipelineLayout({bindGroupLayouts:[this.simParamsUniformLayout,n]}),a=new Float32Array(1048576);a.fill(0);const u={label:"AgentFieldTexture",size:[c,c,1],usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_DST|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING,format:"rgba32float"},l=this.device.createSampler(),f=()=>{const e=this.device.createTexture(u),t=e.createView(),i=this.device.createBindGroup({label:"AgentFieldBindGroup",layout:n,entries:[{binding:0,resource:l},{binding:1,resource:t}]});return this.device.queue.writeTexture({texture:e},a,{bytesPerRow:8192},{width:c,height:c}),{texture:e,view:t,bindGroup:i}};this.agentFieldTextures=[f(),f()];const p={label:"DecayPipeline",layout:r,vertex:{module:t,entryPoint:"vs_main",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x3"}],arrayStride:12,stepMode:"vertex"},{attributes:[{shaderLocation:1,offset:0,format:"float32x2"}],arrayStride:8,stepMode:"vertex"}]},fragment:{module:t,entryPoint:"fs_main",targets:[{format:"rgba32float"}]},primitive:{frontFace:"cw",cullMode:"none",topology:"triangle-list"}};this.agentFieldPipeline=this.device.createRenderPipeline(p);const g=this.device.createBindGroupLayout({label:"AgentUpdate",entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage",minBindingSize:2048}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage",minBindingSize:2048}},{binding:2,visibility:GPUShaderStage.COMPUTE,storageTexture:{format:"rgba32float",viewDimension:"2d"}},{binding:3,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba32float",viewDimension:"2d"}}]});this.agentBindGroups=new Array(2).fill(0).map(((e,t)=>{const i=this.agentFieldTextures[t],n=this.agentFieldTextures[(t+1)%2],r=this.agentBuffers[t],a=this.agentBuffers[(t+1)%2];return{bindGroup:this.device.createBindGroup({label:`AgentCompute${t}`,layout:g,entries:[{binding:0,resource:{buffer:r.buffer}},{binding:1,resource:{buffer:a.buffer}},{binding:2,resource:i.view},{binding:3,resource:n.view}]})}})),this.agentComputePipeline=this.device.createComputePipeline({label:"AgentCompute",compute:{module:i,entryPoint:"compute_main"},layout:this.device.createPipelineLayout({bindGroupLayouts:[this.simParamsUniformLayout,g]})})}initializeBlitResources(){this.unitSquare={positionBuffer:d(this.device,u.vertices,GPUBufferUsage.VERTEX),uvBuffer:d(this.device,u.uvs,GPUBufferUsage.VERTEX),indexBuffer:d(this.device,u.indices,GPUBufferUsage.INDEX)},this.blitModule=this.device.createShaderModule({code:a.default});const e={bindGroupLayouts:[this.device.createBindGroupLayout({label:"BlitBindGroupLayout",entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}}]})]},t=this.device.createPipelineLayout(e),i={module:this.blitModule,entryPoint:"vs_main",buffers:[{attributes:[{shaderLocation:0,offset:0,format:"float32x3"}],arrayStride:12,stepMode:"vertex"},{attributes:[{shaderLocation:1,offset:0,format:"float32x2"}],arrayStride:8,stepMode:"vertex"}]},n={format:navigator.gpu.getPreferredCanvasFormat()},r={label:"BlitPipeline",layout:t,vertex:i,fragment:{module:this.blitModule,entryPoint:"fs_main",targets:[n]},primitive:{frontFace:"cw",cullMode:"none",topology:"triangle-list"}};this.pipeline=this.device.createRenderPipeline(r)}resizeBackings(){if(!this.context){this.context=this.canvas.getContext("webgpu");const e={device:this.device,format:navigator.gpu.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC,alphaMode:"opaque"};this.context.configure(e)}}encodeAgentComputeCommands(e){const t=e.beginComputePass({label:"AgentCompute"});t.setPipeline(this.agentComputePipeline),t.setBindGroup(0,this.simParamBindGroup),t.setBindGroup(1,this.agentBindGroups[this.pingpong].bindGroup),t.dispatchWorkgroups(l,1,1),t.end()}encodeDecayCommands(e){const t=e.beginRenderPass({label:"DecayPass",colorAttachments:[{view:this.agentFieldTextures[(this.pingpong+1)%2].view,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]});t.setPipeline(this.agentFieldPipeline),t.setViewport(0,0,c,c,0,1),t.setScissorRect(0,0,c,c),t.setBindGroup(0,this.simParamBindGroup),t.setBindGroup(1,this.agentFieldTextures[this.pingpong].bindGroup),t.setVertexBuffer(0,this.unitSquare.positionBuffer),t.setVertexBuffer(1,this.unitSquare.uvBuffer),t.setIndexBuffer(this.unitSquare.indexBuffer,"uint16"),t.drawIndexed(6,1),t.end()}encodeBlitCommands(e){const t={label:"BlitPass",colorAttachments:[{view:this.context.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]},i=e.beginRenderPass(t);i.setPipeline(this.pipeline),i.setViewport(0,0,this.canvas.width,this.canvas.height,0,1),i.setScissorRect(0,0,this.canvas.width,this.canvas.height),i.setBindGroup(0,this.agentFieldTextures[this.pingpong].bindGroup),i.setVertexBuffer(0,this.unitSquare.positionBuffer),i.setVertexBuffer(1,this.unitSquare.uvBuffer),i.setIndexBuffer(this.unitSquare.indexBuffer,"uint16"),i.drawIndexed(6,1),i.end()}}},600:e=>{e.exports="// Compute shader\n\nstruct Agent {\n    pos: vec2<f32>,\n    vel: vec2<f32>,\n};\n\nstruct SimParams {\n    randomSeed: f32,\n    deltaT: f32,\n};\n\nstruct ComputeIn {\n    @builtin(global_invocation_id) global_invocation_id: vec3<u32>,\n};\n\n@group(0) @binding(0) var<uniform> params : SimParams;\n@group(1) @binding(0) var<storage, read> agentsSrc : array<Agent>;\n@group(1) @binding(1) var<storage, read_write> agentsDst : array<Agent>;\n@group(1) @binding(2) var fieldSrc : texture_2d<f32>;\n@group(1) @binding(3) var fieldDst : texture_storage_2d<rgba32float, write>;\n\n// const PI: f32 = 3.14159274;\nconst TWO_PI: f32 = 6.28318548;\nconst AGENT_FIELD_SIZE: f32 = 512.0;\nconst AGENT_SPEED: f32 = AGENT_FIELD_SIZE / 10.0; // field units/second\nconst FIELD_MIN: vec2<f32> = vec2(0.0);\nconst FIELD_MAX: vec2<f32> = vec2(AGENT_FIELD_SIZE);\n\n// https://gist.github.com/patriciogonzalezvivo/670c22f3966e662d2f83\nfn rand(n: f32) -> f32 {\n    return fract(sin(n + params.randomSeed) * 43758.5453123);\n}\n\nfn random_angle(in: f32) -> vec2<f32> {\n    let angle = rand(in) * TWO_PI;\n\n    return vec2<f32>(\n        cos(angle),\n        sin(angle),\n    ) * AGENT_SPEED;\n}\n\n@compute\n@workgroup_size(64)\nfn compute_main(in: ComputeIn) {\n    let total = arrayLength(&agentsSrc);\n    let index = in.global_invocation_id.x;\n    // TODO: What is this guarding against?\n    if index >= total {\n        return;\n    }\n\n    var vel = agentsSrc[index].vel;\n    var pos = agentsSrc[index].pos + vel * params.deltaT;\n\n    // // Keep particles in bounds\n    if pos.x < 0 || pos.x > AGENT_FIELD_SIZE || pos.y < 0 || pos.y > AGENT_FIELD_SIZE {\n        pos = clamp(pos, FIELD_MIN, FIELD_MAX); // Reset position and pick a new angle\n\n        // Random bounce angle\n        vel = random_angle(vel.x + vel.y + f32(in.global_invocation_id.x));\n        // vel = -vel;\n    }\n\n\n    // // Update agent\n    agentsDst[index] = Agent(pos, vel);\n\n    // Write data to field\n    // textureStore(fieldDst, vec2<u32>(12, 12), vec4<f32>(1.0));\n    textureStore(fieldDst, vec2<i32>(pos), vec4(1.0));\n}\n"},861:e=>{e.exports="struct VertexInput {\n    @location(0) pos: vec3f,\n    @location(1) uv: vec2f,\n}\n\nstruct VertexOutput {\n    @builtin(position) pos: vec4f,\n    @location(0) uv: vec2f,\n };\n\n@vertex\nfn vs_main(in: VertexInput) -> VertexOutput {\n    var out: VertexOutput;\n\n    out.pos = vec4f(in.pos, 1);\n    out.uv = in.uv;\n\n    return out;\n}\n\n@group(0) @binding(0) var fieldSampler: sampler;\n@group(0) @binding(1) var fieldTexture: texture_2d<f32>;\n\n@fragment\nfn fs_main(in: VertexOutput) -> @location(0) vec4f {\n    return vec4(textureSample(fieldTexture, fieldSampler, in.uv).rgb, 1.0);\n}\n"},535:e=>{e.exports="struct VertexInput {\n    @location(0) pos: vec3f,\n    @location(1) uv: vec2f,\n}\n\nstruct VertexOutput {\n    @builtin(position) pos: vec4f,\n    @location(0) uv: vec2f,\n };\n\n@vertex\nfn vs_main(in: VertexInput) -> VertexOutput {\n    var out: VertexOutput;\n\n    out.pos = vec4f(in.pos, 1);\n    out.uv = in.uv;\n\n    return out;\n}\n\nstruct SimParams {\n    randomSeed: f32,\n    deltaT: f32,\n};\n\n@group(0) @binding(0) var<uniform> params : SimParams;\n\n@group(1) @binding(0) var fieldSampler: sampler;\n@group(1) @binding(1) var fieldTexture: texture_2d<f32>;\n\nconst DECAY_RATE = 0.06; // units/second\n\n@fragment\nfn fs_main(in: VertexOutput) -> @location(0) vec4f {\n    var pixelStep = vec2(1.0) / vec2f(textureDimensions(fieldTexture));\n\n    var color_out = vec4f();\n\n    // Diffusion 3x3 blur\n    var sum = vec4f();\n    for (var i = -1; i <= 1; i++) {\n        for (var j = -1; j <= 1; j++) {\n            sum += textureSample(fieldTexture, fieldSampler, in.uv + pixelStep * vec2f(f32(i), f32(j)));\n        }\n    }\n    // TODO: This should somehow be factored by time\n    color_out += sum / 9.0;\n\n    // Decay\n    color_out = max(vec4(), color_out - vec4(DECAY_RATE) * params.deltaT);\n\n    return color_out;\n}\n"}},t={};!function i(n){var r=t[n];if(void 0!==r)return r.exports;var a=t[n]={exports:{}};return e[n].call(a.exports,a,a.exports,i),a.exports}(312)})();